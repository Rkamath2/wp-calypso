@startuml

'red: #facfd2
'orange: #f7dcc6
'yellow: #f5e6b3
'green: #b8e6bf

skinparam ParticipantPadding 5
skinparam BoxPadding 5
box "WordPress.com" #facfd2
  participant WPCOM_JSON_API_Me_Shopping_Cart_Endpoint as "WPCOM_JSON_API_\nMe_Shopping_Cart_\nEndpoint"
end box
box "Calypso" #f7dcc6
  participant Undocumented
end box
box "Actions" #f5e6b3
	control CheckoutController as "/checkout/"
end box
box "Composite Checkout" #b8e6bf
  participant CompositeCheckout
  participant usePrepareProductsForCart
  participant useShoppingCartManager
  participant useInitializeCartFromServer
  participant useShoppingCartReducer
  participant useCartUpdateAndRevalidate
end box

'Imports
Undocumented -> CompositeCheckout : import setCart
note over CompositeCheckout
	setCart from props
	or fall back to import
end note
CompositeCheckout -> useShoppingCartManager : setCart
useShoppingCartManager -> useCartUpdateAndRevalidate : setCart

'Page load
note over CheckoutController
	Extracts parameters
	from URL path
end note
CheckoutController -> CompositeCheckout : product, purchaseId
CompositeCheckout -> usePrepareProductsForCart : product, purchaseId
alt Plan
	hnote over usePrepareProductsForCart
		no purchaseId
		product in getPlans
	end hnote
	usePrepareProductsForCart -> CompositeCheckout : << createItemToAddToCart >>
else Product
	hnote over usePrepareProductsForCart
		no purchaseId
		product not in getPlans
		product in getProductsList
	end hnote
	usePrepareProductsForCart -> CompositeCheckout : << createItemToAddToCart >>
else Renewal
	hnote over usePrepareProductsForCart
		has purchaseId
		product in getProductsList
	end hnote
	usePrepareProductsForCart -> CompositeCheckout : << createRenewalItemToAddToCart >>\n\t<< getRenewalItemFromCartItem >>
end
CompositeCheckout -> useShoppingCartManager : productsToAddOnInitialize
useShoppingCartManager -> useInitializeCartFromServer : productsToAddOnInitialize
useInitializeCartFromServer -> Undocumented : << setCart >>
activate Undocumented
Undocumented -> WPCOM_JSON_API_Me_Shopping_Cart_Endpoint : POST /me/shopping-cart/{cartKey}
activate WPCOM_JSON_API_Me_Shopping_Cart_Endpoint
'Explain renewal flags
note over WPCOM_JSON_API_Me_Shopping_Cart_Endpoint
	getRenewalItemFromCartItem adds

	{ extra: {
		purchaseType: 'renewal'
	} }
end note
return
return
note over useInitializeCartFromServer
	Dispatch
	RECEIVE_INITIAL_RESPONSE_CART
end note

'Active purchasing
useShoppingCartManager -> CheckoutController : addItem
note over CheckoutController
	<< getRenewableSitePurchases >>
	sent to
	<< getRenewalItemFromProduct >>
		<< getRenewalItemFromCartItem >>
end note

'Cache invalidation
CheckoutController -> useShoppingCartReducer : << addItem >>\ndispatches\nADD_CART_ITEM
note over useShoppingCartReducer
	cacheStatus: 'invalid'
end note
useShoppingCartReducer -> useCartUpdateAndRevalidate : cacheStatus
note over useCartUpdateAndRevalidate
	Dispatch
	REQUEST_UPDATED_RESPONSE_CART
end note
useCartUpdateAndRevalidate -> Undocumented : << setCart >>
activate Undocumented
Undocumented -> WPCOM_JSON_API_Me_Shopping_Cart_Endpoint : POST /me/shopping-cart/{cartKey}
activate WPCOM_JSON_API_Me_Shopping_Cart_Endpoint
'Explain renewal flags
note over WPCOM_JSON_API_Me_Shopping_Cart_Endpoint
	getRenewalItemFromCartItem adds

	{ extra: {
		purchaseType: 'renewal'
	} }
end note
return
return

@enduml
